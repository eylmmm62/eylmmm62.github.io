<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneralAgent智能助手</title>
    <!-- 引入marked.js用于Markdown解析 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* 科技未来感聊天界面样式系统 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0A0E27 0%, #020308 100%);
            color: #E8F4FD;
            overflow-x: hidden;
            position: relative;
        }

        /* 动态量子粒子背景 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #00FFFF, transparent),
                radial-gradient(2px 2px at 40px 70px, #6C5CE7, transparent),
                radial-gradient(1px 1px at 90px 40px, #00FFFF, transparent),
                radial-gradient(1px 1px at 130px 80px, #6C5CE7, transparent),
                radial-gradient(2px 2px at 160px 30px, #00FFFF, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: quantumParticles 20s linear infinite;
            opacity: 0.3;
            z-index: -1;
        }

        @keyframes quantumParticles {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-200px, -100px); }
        }

        /* 网格背景效果 */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(108, 92, 231, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(108, 92, 231, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.2;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .content-area {
            display: flex;
            gap: 25px;
            align-items: flex-start;
        }

        /* 标签容器 - 磨砂玻璃效果 */
        /* 标签容器 - 磨砂玻璃效果 */
        .label-container {
            width: 220px;
            min-width: 220px;
            max-width: 220px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(108, 92, 231, 0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .label-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00FFFF, transparent);
            animation: scanLine 3s ease-in-out infinite;
        }

        @keyframes scanLine {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .label-container h2 {
            color: #00FFFF;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            font-weight: 300;
            letter-spacing: 1px;
        }

        .label-list {
            list-style-type: none;
        }

        .label-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(108, 92, 231, 0.2);
            position: relative;
            overflow: hidden;
            width: 174px;
            box-sizing: border-box;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .label-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .label-item:hover::before {
            left: 100%;
        }

        /* 暗金色流光特效 */
        .label-item.golden-flow {
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .label-item.golden-flow::before {
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 215, 0, 0.3), 
                rgba(255, 223, 0, 0.4), 
                rgba(255, 215, 0, 0.3), 
                transparent
            );
            animation: goldenFlowAnimation 2s ease-in-out infinite;
        }

        .label-item.golden-flow::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(255, 215, 0, 0.4), 
                rgba(255, 223, 0, 0.2), 
                rgba(255, 215, 0, 0.4)
            );
            border-radius: 12px;
            z-index: -1;
            animation: goldenBorderFlow 3s linear infinite;
        }

        @keyframes goldenFlowAnimation {
            0% {
                left: -100%;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }

        @keyframes goldenBorderFlow {
            0% {
                background: linear-gradient(45deg, 
                    rgba(255, 215, 0, 0.4), 
                    rgba(255, 223, 0, 0.2), 
                    rgba(255, 215, 0, 0.4)
                );
            }
            25% {
                background: linear-gradient(45deg, 
                    rgba(255, 223, 0, 0.2), 
                    rgba(255, 215, 0, 0.4), 
                    rgba(255, 223, 0, 0.2)
                );
            }
            50% {
                background: linear-gradient(45deg, 
                    rgba(255, 215, 0, 0.4), 
                    rgba(255, 223, 0, 0.2), 
                    rgba(255, 215, 0, 0.4)
                );
            }
            75% {
                background: linear-gradient(45deg, 
                    rgba(255, 223, 0, 0.2), 
                    rgba(255, 215, 0, 0.4), 
                    rgba(255, 223, 0, 0.2)
                );
            }
            100% {
                background: linear-gradient(45deg, 
                    rgba(255, 215, 0, 0.4), 
                    rgba(255, 223, 0, 0.2), 
                    rgba(255, 215, 0, 0.4)
                );
            }
        }

        .label-item.golden-flow:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
            color: #FFD700;
        }

        /* 浅红色流光特效 */
        .label-item.red-flow {
            background: rgba(255, 99, 99, 0.05);
            border: 1px solid rgba(255, 99, 99, 0.3);
            box-shadow: 0 0 15px rgba(255, 99, 99, 0.2);
            position: relative;
            overflow: hidden;
        }

        .label-item.red-flow::before {
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 99, 99, 0.3), 
                rgba(255, 120, 120, 0.4), 
                rgba(255, 99, 99, 0.3), 
                transparent
            );
            animation: redFlowAnimation 2s ease-in-out infinite;
        }

        .label-item.red-flow::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(255, 99, 99, 0.4), 
                rgba(255, 120, 120, 0.2), 
                rgba(255, 99, 99, 0.4)
            );
            border-radius: 12px;
            z-index: -1;
            animation: redBorderFlow 3s linear infinite;
        }

        @keyframes redFlowAnimation {
            0% {
                left: -100%;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }

        @keyframes redBorderFlow {
            0% {
                background: linear-gradient(45deg, 
                    rgba(255, 99, 99, 0.4), 
                    rgba(255, 120, 120, 0.2), 
                    rgba(255, 99, 99, 0.4)
                );
            }
            25% {
                background: linear-gradient(45deg, 
                    rgba(255, 120, 120, 0.2), 
                    rgba(255, 99, 99, 0.4), 
                    rgba(255, 120, 120, 0.2)
                );
            }
            50% {
                background: linear-gradient(45deg, 
                    rgba(255, 99, 99, 0.4), 
                    rgba(255, 120, 120, 0.2), 
                    rgba(255, 99, 99, 0.4)
                );
            }
            75% {
                background: linear-gradient(45deg, 
                    rgba(255, 120, 120, 0.2), 
                    rgba(255, 99, 99, 0.4), 
                    rgba(255, 120, 120, 0.2)
                );
            }
            100% {
                background: linear-gradient(45deg, 
                    rgba(255, 99, 99, 0.4), 
                    rgba(255, 120, 120, 0.2), 
                    rgba(255, 99, 99, 0.4)
                );
            }
        }

        .label-item.red-flow:hover {
            background: rgba(255, 99, 99, 0.1);
            border-color: rgba(255, 99, 99, 0.5);
            box-shadow: 0 0 25px rgba(255, 99, 99, 0.4);
            transform: translateY(-2px);
            color: #FF6363;
        }

        .label-item:hover {
            background: rgba(108, 92, 231, 0.1);
            border-color: #00FFFF;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .label-item.active {
            background: rgba(108, 92, 231, 0.2);
            border-color: #6C5CE7;
            box-shadow: 
                0 0 25px rgba(108, 92, 231, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: #00FFFF;
            font-weight: 500;
        }

        /* 聊天容器 - 液态金属质感 */
        .chat-container {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(108, 92, 231, 0.5);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #6c5ce72a, #00ffff13, #6c5ce727);
            border-radius: 25px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chat-container:hover::before {
            opacity: 0.3;
        }

/* 工作中状态的容器特效 - 蓝紫暗色系金属玻璃质感 */
/* .chat-container.working {
    border: 2px solid transparent;
    background: 
        linear-gradient(rgba(255, 255, 255, 0.015), rgba(255, 255, 255, 0.005)) padding-box,
        linear-gradient(45deg, #050A14, #0A1428, #122340, #1E3A8A) border-box;
    animation: workingGlow 3s ease-in-out infinite;
    backdrop-filter: blur(15px);
}

.chat-container.working::before {
    opacity: 0.25;
    background: linear-gradient(45deg, #050A14, #0A1428, #122340, #1E3A8A);
    filter: blur(4px);
    animation: borderFlow 5s linear infinite;
}

.chat-container.working::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(18, 35, 64, 0.07) 0%, transparent 60%),
        radial-gradient(circle at 80% 50%, rgba(30, 58, 138, 0.05) 0%, transparent 60%),
        radial-gradient(circle at 50% 20%, rgba(26, 54, 126, 0.07) 0%, transparent 60%),
        radial-gradient(circle at 30% 80%, rgba(5, 10, 20, 0.05) 0%, transparent 60%);
    border-radius: 25px;
    z-index: -1;
    animation: workingBackground 12s ease-in-out infinite;
}

@keyframes workingGlow {
    0%, 100% {
        box-shadow: 
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 15px rgba(18, 35, 64, 0.2),
            0 0 30px rgba(30, 58, 138, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.04),
            inset 0 -1px 0 rgba(30, 58, 138, 0.1);
    }
    50% {
        box-shadow: 
            0 12px 40px rgba(0, 0, 0, 0.8),
            0 0 25px rgba(18, 35, 64, 0.3),
            0 0 45px rgba(30, 58, 138, 0.2),
            0 0 60px rgba(49, 110, 244, 0.15),
            inset 0 1px 0 rgba(255, 255, 255, 0.06),
            inset 0 -1px 0 rgba(30, 58, 138, 0.15);
    }
}

@keyframes borderFlow {
    0% {
        background: linear-gradient(45deg, #050A14, #0A1428, #122340, #1E3A8A);
    }
    25% {
        background: linear-gradient(45deg, #122340, #050A14, #1E3A8A, #0A1428);
    }
    50% {
        background: linear-gradient(45deg, #1E3A8A, #122340, #0A1428, #050A14);
    }
    75% {
        background: linear-gradient(45deg, #0A1428, #1E3A8A, #050A14, #122340);
    }
    100% {
        background: linear-gradient(45deg, #050A14, #0A1428, #122340, #1E3A8A);
    }
}

@keyframes workingBackground {
    0%, 100% {
        opacity: 0.2;
        transform: scale(1);
    }
    50% {
        opacity: 0.35;
        transform: scale(1.02);
    }
} */

        .chat-container h1 {
            color: #00FFFF;
            font-size: 28px;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            font-weight: 300;
            letter-spacing: 2px;
        }

        /* 聊天框 - 全息显示效果 */
        .chat-box {
            min-height: 450px;
            height: calc(100vh - 300px);
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1);
            position: relative;
        }

        .chat-box::-webkit-scrollbar {
            width: 8px;
        }

        .chat-box::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #6C5CE7, #00FFFF);
            border-radius: 4px;
        }

        /* 消息气泡 - 全息投影质感 */
        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            backdrop-filter: blur(10px);
            animation: messageAppear 0.5s ease-out;
        }

        @keyframes messageAppear {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .user-message {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            margin-left: auto;
            text-align: right;
            box-shadow: 
                0 0 20px rgba(0, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .user-message::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, transparent, #00FFFF, transparent);
            border-radius: 20px;
            z-index: -1;
            opacity: 0.3;
        }

        .ai-message {
            background: rgba(108, 92, 231, 0.1);
            border: 1px solid rgba(108, 92, 231, 0.3);
            margin-right: auto;
            box-shadow: 
                0 0 20px rgba(108, 92, 231, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .ai-message::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, transparent, #6C5CE7, transparent);
            border-radius: 20px;
            z-index: -1;
            opacity: 0.3;
        }

        /* Markdown样式优化 */
        .ai-message p {
            margin: 0 0 10px 0;
            line-height: 1.6;
        }

        .ai-message p:last-child {
            margin-bottom: 0;
        }

        .ai-message pre {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            margin: 10px 0;
            backdrop-filter: blur(5px);
        }

        .ai-message code {
            background: rgba(0, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .ai-message pre code {
            background: transparent;
            padding: 0;
            border: none;
        }

        .ai-message ul, .ai-message ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .ai-message blockquote {
            border-left: 3px solid #00FFFF;
            padding-left: 15px;
            margin-left: 0;
            color: rgba(232, 244, 253, 0.8);
            background: rgba(0, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
        }

        .ai-message img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ai-message img:hover {
            border-color: #00FFFF;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            transform: scale(1.02);
        }

        /* 图片容器样式 */
        .image-container {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-item:hover {
            border-color: #00FFFF;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .image-item img {
            width: 100%;
            height: auto;
            display: block;
            border: none;
            border-radius: 0;
        }

        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.1);
            color: rgba(232, 244, 253, 0.6);
            font-size: 14px;
        }

        .image-error {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            background: rgba(255, 0, 0, 0.1);
            color: rgba(255, 100, 100, 0.8);
            font-size: 14px;
            border: 1px solid rgba(255, 0, 0, 0.2);
            cursor: pointer;
        }

        /* 图片预览弹窗 */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.3);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 30px;
            cursor: pointer;
            z-index: 2001;
        }

        .ai-message table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .ai-message th, .ai-message td {
            border: 1px solid rgba(108, 92, 231, 0.3);
            padding: 10px;
            text-align: left;
        }

        .ai-message th {
            background: rgba(108, 92, 231, 0.2);
            color: #00FFFF;
        }

        /* 输入区域 - 液态金属质感 */
        .input-area {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #user-input {
            flex-grow: 1;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 25px;
            font-size: 16px;
            color: #E8F4FD;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            outline: none;
        }

        #user-input::placeholder {
            color: rgba(232, 244, 253, 0.5);
        }

        #user-input:focus {
            border-color: #00FFFF;
            box-shadow: 
                0 0 25px rgba(0, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        /* 按钮 - 能量波纹效果 */
        button {
            padding: 15px 25px;
            background: linear-gradient(45deg, #6C5CE7, #8B7CF8);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        button:hover::before {
            width: 300px;
            height: 300px;
        }

        button:hover {
            background: linear-gradient(45deg, #8B7CF8, #00FFFF);
            box-shadow: 
                0 6px 25px rgba(108, 92, 231, 0.4),
                0 0 30px rgba(0, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* 加载动画 - 量子旋转效果 */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #00FFFF;
            animation: quantumSpin 1s ease-in-out infinite;
            margin-left: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        @keyframes quantumSpin {
            0% { 
                transform: rotate(0deg);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            }
            100% { 
                transform: rotate(360deg);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            }
        }

        /* Banner样式 */
        .banner {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(108, 92, 231, 0.3);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00FFFF, transparent);
            animation: scanLine 6s ease-in-out infinite;
        }

        .banner-title {
            color: #00FFFF;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
            margin: 0;
        }

        .work-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #E8F4FD;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00FF00;
            box-shadow: 
                0 0 10px rgba(0, 255, 0, 0.5),
                0 0 20px rgba(0, 255, 0, 0.3),
                0 0 30px rgba(0, 255, 0, 0.1);
            animation: statusPulse 2s ease-in-out infinite;
            position: relative;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(0, 255, 0, 0.3);
            animation: statusRing 2s ease-in-out infinite;
        }

        .status-indicator.working {
            background: linear-gradient(45deg, #4A90E2, #6C5CE7);
            box-shadow: 
                0 0 15px rgba(74, 144, 226, 0.8),
                0 0 30px rgba(108, 92, 231, 0.5),
                0 0 45px rgba(0, 255, 255, 0.3);
            animation: workingPulse 1s ease-in-out infinite;
        }

        .status-indicator.working::before {
            border: 1px solid rgba(74, 144, 226, 0.5);
            animation: workingRing 1s ease-in-out infinite;
        }

        .status-indicator.working::after {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border-radius: 50%;
            background: transparent;
            border: 2px solid transparent;
            border-top: 2px solid rgba(0, 255, 255, 0.8);
            border-right: 2px solid rgba(108, 92, 231, 0.6);
            animation: workingSpin 2s linear infinite;
        }

        @keyframes statusPulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        @keyframes statusRing {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.3;
            }
            50% { 
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes workingPulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
                box-shadow: 
                    0 0 15px rgba(74, 144, 226, 0.8),
                    0 0 30px rgba(108, 92, 231, 0.5),
                    0 0 45px rgba(0, 255, 255, 0.3);
            }
            50% { 
                opacity: 0.8;
                transform: scale(1.2);
                box-shadow: 
                    0 0 25px rgba(74, 144, 226, 1),
                    0 0 50px rgba(108, 92, 231, 0.8),
                    0 0 75px rgba(0, 255, 255, 0.5);
            }
        }

        @keyframes workingRing {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.5;
            }
            50% { 
                transform: scale(2);
                opacity: 0;
            }
        }

        @keyframes workingSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .settings-btn {
            padding: 10px 20px;
            background: linear-gradient(45deg, #6C5CE7, #8B7CF8);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .settings-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .settings-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .settings-btn:hover {
            background: linear-gradient(45deg, #8B7CF8, #00FFFF);
            box-shadow: 
                0 6px 25px rgba(108, 92, 231, 0.4),
                0 0 30px rgba(0, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* 设置弹窗样式 */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.show {
            display: flex;
        }

        .settings-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(108, 92, 231, 0.5);
            border-radius: 20px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .settings-content h3 {
            color: #00FFFF;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            font-weight: 300;
            letter-spacing: 1px;
        }

        .settings-content label {
            display: block;
            color: #E8F4FD;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .settings-content input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 14px;
            color: #E8F4FD;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            outline: none;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .settings-content input[type="text"]:focus {
            border-color: #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .settings-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .save-btn, .cancel-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .save-btn {
            background: linear-gradient(45deg, #6C5CE7, #8B7CF8);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #E8F4FD;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .save-btn:hover {
            background: linear-gradient(45deg, #8B7CF8, #00FFFF);
            box-shadow: 0 6px 25px rgba(108, 92, 231, 0.4);
            transform: translateY(-2px);
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }
            
            .content-area {
                flex-direction: column;
            }
            
            .label-container {
                width: 100%;
                margin-bottom: 20px;
            }
            
            .chat-box {
                min-height: 350px;
                height: calc(100vh - 250px);
            }
            
            .input-area {
                flex-direction: column;
                gap: 10px;
            }
            
            #user-input {
                width: 100%;
            }

            .banner {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .banner-title {
                font-size: 20px;
            }

            .settings-content {
                width: 350px;
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- Banner -->
    <div class="main-container">
        <div class="banner">
            <h1 class="banner-title">泛用型多模态智能助手（演示版）</h1>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div class="work-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="status-text">闲置</span>
                </div>
                <button class="settings-btn" id="settings-btn">设置</button>
            </div>
        </div>
        
        <div class="content-area">
            <div class="label-container">
                <h2>对话标签</h2>
                <ul class="label-list" id="label-list">
                    <li class="label-item active" data-label="任务管理器">任务管理器</li>
                </ul>
            </div>
            <div class="chat-container">
            <h3>AI对话助手</h3>
            <div class="chat-box" id="chat-box">
                <div class="message ai-message">您好！我是GeneralAgent智能助手，请问有什么可以帮助您的？（目前已支持：解决方案，计划任务，画图，BGM，音乐等类型任务）</div>
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="请输入您的问题..." autofocus>
                <button id="send-btn">发送</button>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <h3>API设置</h3>
            <label for="api-key-input">API Key:</label>
            <input type="text" id="api-key-input" placeholder="请输入您的API Key">
            <div class="settings-buttons">
                <button class="save-btn" id="save-settings">保存</button>
                <button class="cancel-btn" id="cancel-settings">取消</button>
            </div>
        </div>
    </div>

    <!-- 图片预览弹窗 -->
    <div class="image-modal" id="image-modal">
        <div class="image-modal-close" id="image-modal-close">&times;</div>
        <img id="modal-image" src="" alt="预览图片">
    </div>

    <script>
        // API配置
        const config = {
            apiKey: "pat_kCTJK4639k3OAhb55rU4GXzF7at5AMnThPlb4p72rdN4IMtrelEukKFp2hXOSrZ5",
            workflowId: "7535820020266418202",
            appId: "7530197273070845962"
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const chatBox = document.getElementById('chat-box');
            const userinput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const labelList = document.getElementById('label-list');
            
            // 聊天记录存储
            const chatHistory = {
                "任务管理器": [{
                    sender: 'ai',
                    message: '请查阅当前任务信息'
                }]
            };
            
            // 当前活动标签
            let currentLabel = "任务管理器";
            
            // 工作状态管理
            let isWorking = false;
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            function setWorkingStatus(working) {
                isWorking = working;
                const chatContainer = document.querySelector('.chat-container');
                
                if (working) {
                    statusIndicator.classList.add('working');
                    statusText.textContent = '工作中';
                    sendBtn.disabled = true;
                    sendBtn.style.opacity = '0.5';
                    sendBtn.style.cursor = 'not-allowed';
                    
                    // 添加工作中的视觉特效
                    chatContainer.classList.add('working');
                } else {
                    statusIndicator.classList.remove('working');
                    statusText.textContent = '闲置';
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    sendBtn.style.cursor = 'pointer';
                    
                    // 移除工作中的视觉特效
                    chatContainer.classList.remove('working');
                }
            }
            
            // 添加新标签函数
            function addNewLabel(labelName) {
                if (!chatHistory[labelName]) {
                    chatHistory[labelName] = [{
                        sender: 'ai',
                        message: '请查阅当前任务信息'
                    }];
                    
                    const newLabelItem = document.createElement('li');
                    newLabelItem.className = 'label-item';
                    
                    // 检查是否为"任务报告"，如果是则添加暗金色流光特效
                    if (labelName === '任务报告') {
                        newLabelItem.classList.add('golden-flow');
                    }
                    
                    // 检查是否为"HR"，如果是则添加浅红色流光特效
                    if (labelName === 'HR') {
                        newLabelItem.classList.add('red-flow');
                    }
                    
                    newLabelItem.dataset.label = labelName;
                    newLabelItem.textContent = labelName;
                    newLabelItem.addEventListener('click', function() {
                        switchLabel(labelName);
                    });
                    
                    labelList.appendChild(newLabelItem);
                }
                switchLabel(labelName);
            }
            
            // 切换标签函数
            function switchLabel(labelName) {
                // 更新活动标签样式
                document.querySelectorAll('.label-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.label === labelName) {
                        item.classList.add('active');
                    }
                });
                
                // 更新当前标签
                currentLabel = labelName;
                
                // 更新聊天框内容
                updateChatBox();
            }
            
            // 更新聊天框内容
            function updateChatBox() {
                chatBox.innerHTML = '';
                if (chatHistory[currentLabel]) {
                    chatHistory[currentLabel].forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = msg.sender === 'user' ? 'message user-message' : 'message ai-message';
                        
                        // 处理文本内容
                        if (msg.message && msg.message.trim()) {
                            const textDiv = document.createElement('div');
                            if (msg.sender === 'ai') {
                                textDiv.innerHTML = marked.parse(msg.message);
                            } else {
                                textDiv.textContent = msg.message;
                            }
                            messageDiv.appendChild(textDiv);
                        }
                        
                        // 处理图片内容
                        if (msg.images && msg.images.length > 0) {
                            const imageContainer = createImageContainer(msg.images);
                            if (imageContainer) {
                                messageDiv.appendChild(imageContainer);
                            }
                        }
                        
                        chatBox.appendChild(messageDiv);
                    });
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            
            // 发送消息函数
            async function sendMessage() {
                const message = userinput.value.trim();
                if (!message || isWorking) return;
                
                // 设置为工作中状态
                setWorkingStatus(true);
                
                // 添加用户消息到聊天历史和聊天框
                chatHistory[currentLabel].push({
                    sender: 'user',
                    message: message
                });
                
                // 更新聊天框
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user-message';
                messageDiv.textContent = message;
                chatBox.appendChild(messageDiv);
                
                userinput.value = '';
                
                // 显示加载状态
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message ai-message';
                loadingDiv.innerHTML = '<div class="loading"></div> AI正在思考...';
                chatBox.appendChild(loadingDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
                
                try {
                    // 调用API
                    const response = await fetch('https://api.coze.cn/v1/workflow/stream_run', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${config.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            workflow_id: config.workflowId,
                            app_id: config.appId,
                            parameters: {
                                userinput: message
                            }
                        })
                    });
                    
                    // 移除加载状态
                    chatBox.removeChild(loadingDiv);
                    
                    if (!response.ok) {
                        throw new Error(`API错误: ${response.status}`);
                    }
                    
                    // 处理流式响应
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        try {
                            // 解析API返回的事件流格式
                            const lines = chunk.split('\n').filter(line => line.trim());
                            let currentEvent = '';
                            
                            for (const line of lines) {
                                if (line.startsWith('event: ')) {
                                    currentEvent = line.substring(7).trim();
                                    continue;
                                }
                                
                                if (line.startsWith('id: ')) {
                                    continue; // 跳过id行
                                }
                                
                                if (line.startsWith('data: ')) {
                                    const jsonStr = line.substring(6);
                                    
                                    // 检查是否为Done事件
                                    if (currentEvent === 'Done') {
                                        // 收到Done事件，恢复闲置状态
                                        setWorkingStatus(false);
                                        continue;
                                    }
                                    
                                    if (jsonStr === '[DONE]') {
                                        // 收到DONE信号，恢复闲置状态
                                        setWorkingStatus(false);
                                        continue;
                                    }
                                    
                                    try {
                                        const jsonData = JSON.parse(jsonStr);
                                        if (jsonData.content && jsonData.content_type === "text") {
                                            // 解析返回的XML格式内容
                                            const content = jsonData.content;
                                            
                                            // 提取<Name>标签中的内容（同时支持大小写）
                                            const nameMatch = content.match(/<[Nn]ame>([\s\S]*?)<\/[Nn]ame>/);
                                            let labelName = currentLabel; // 默认使用当前标签
                                            
                                            // 如果Name标签存在但内容为空，则不显示该回复
                                            if (nameMatch && (!nameMatch[1] || !nameMatch[1].trim())) {
                                                continue; // 跳过这条回复，不显示到对话窗口
                                            }
                                            
                                            if (nameMatch && nameMatch[1] && nameMatch[1].trim()) {
                                                labelName = nameMatch[1].trim();
                                                
                                                // 判断是否为参考图或音频参考
                                                if (labelName === '参考图' || labelName === '音频参考') {
                                                    // 提取<Url>标签中的链接地址
                                                    const urlMatch = content.match(/<Url>([\s\S]*?)<\/Url>/);
                                                    if (urlMatch && urlMatch[1] && urlMatch[1].trim()) {
                                                        const urlString = urlMatch[1].trim();
                                                        
                                                        // 如果是音频参考
                                                        if (labelName === '音频参考') {
                                                            // 首先确保创建音频参考标签
                                                            if (!chatHistory[labelName]) {
                                                                addNewLabel(labelName);
                                                            }
                                                            
                                                            // 处理两种情况：1. 使用Url标签 2. 使用Report标签
                                                            // 先尝试从Url标签获取音频URL
                                                            const audioUrl = urlString;
                                                            
                                                            // 创建音频元素
                                                            const audioMessage = `<audio controls src="${audioUrl}" style="width:100%;margin:10px 0;"></audio>`;
                                                            
                                                            // 将音频消息添加到音频参考label的聊天窗口
                                                            if (labelName === currentLabel) {
                                                                // 如果是当前标签，直接添加到聊天框
                                                                addMessage(audioMessage, 'ai');
                                                            } else {
                                                                // 如果不是当前标签，只添加到聊天历史
                                                                chatHistory[labelName].push({
                                                                    sender: 'ai',
                                                                    message: audioMessage
                                                                });
                                                            }
                                                            continue; // 跳过后续的处理
                                                        } else {
                                                            // 处理图片参考
                                                            // 解析URL数组
                                                            const imageUrls = parseUrlArray(urlString);
                                                            
                                                            if (imageUrls.length > 0) {
                                                                // 如果没有参考图label，则创建新的label
                                                                if (!chatHistory[labelName]) {
                                                                    addNewLabel(labelName);
                                                                }
                                                                
                                                                // 将图片消息添加到参考图label的聊天窗口
                                                                if (labelName === currentLabel) {
                                                                    // 如果是当前标签，直接添加到聊天框
                                                                    addMessage('', 'ai', imageUrls);
                                                                } else {
                                                                    // 如果不是当前标签，只添加到聊天历史
                                                                    chatHistory[labelName].push({
                                                                        sender: 'ai',
                                                                        message: '',
                                                                        images: imageUrls
                                                                    });
                                                                }
                                                                continue; // 跳过后续的Report处理
                                                            }
                                                        }
                                                    }
                                                } else {
                                                    // 如果没有对应label，则创建新的label
                                                    if (!chatHistory[labelName]) {
                                                        addNewLabel(labelName);
                                                    }
                                                }
                                            }
                                            
                                            // 提取<Report>标签中的内容
                                            const reportMatch = content.match(/<Report>([\s\S]*?)<\/Report>/);
                                            if (reportMatch && reportMatch[1]) {
                                                const messageContent = reportMatch[1].trim();
                                                
                                                // 检查是否为音频参考但使用了Report标签
                                                if (labelName === '音频参考') {
                                                    // 确保创建音频参考标签
                                                    if (!chatHistory[labelName]) {
                                                        addNewLabel(labelName);
                                                    }
                                                    
                                                    // 创建音频元素
                                                    const audioMessage = `<audio controls src="${messageContent}" style="width:100%;margin:10px 0;"></audio>`;
                                                    
                                                    // 将音频消息添加到音频参考label的聊天窗口
                                                    if (labelName === currentLabel) {
                                                        // 如果是当前标签，直接添加到聊天框
                                                        addMessage(audioMessage, 'ai');
                                                    } else {
                                                        // 如果不是当前标签，只添加到聊天历史
                                                        chatHistory[labelName].push({
                                                            sender: 'ai',
                                                            message: audioMessage
                                                        });
                                                    }
                                                } else {
                                                    // 将消息添加到对应label的聊天窗口
                                                    if (labelName === currentLabel) {
                                                        // 如果是当前标签，直接添加到聊天框
                                                        addMessage(messageContent, 'ai');
                                                    } else {
                                                        // 如果不是当前标签，只添加到聊天历史
                                                        chatHistory[labelName].push({
                                                            sender: 'ai',
                                                            message: messageContent
                                                        });
                                                    }
                                                }
                                            }
                                        }
                                    } catch (jsonError) {
                                        console.error('解析JSON出错:', jsonError);
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('解析响应出错:', e);
                        }
                    }
                    
                    // // 如果没有收到任何消息，显示错误提示
                    // const aiMessages = document.querySelectorAll('.ai-message');
                    // const initialMessageCount = chatHistory[currentLabel].filter(msg => msg.sender === 'ai').length;
                    // if (aiMessages.length <= initialMessageCount) {
                    //     addMessage('抱歉，我无法处理您的请求。', 'ai');
                    // }
                    
                } catch (error) {
                    console.error('API调用出错:', error);
                    // 移除加载状态
                    if (chatBox.contains(loadingDiv)) {
                        chatBox.removeChild(loadingDiv);
                    }
                    addMessage('抱歉，发生了错误: ' + error.message, 'ai');
                    // 发生错误时也要恢复闲置状态
                    setWorkingStatus(false);
                }
            }
            
            // URL验证和清理函数
            function cleanAndValidateUrl(url) {
                if (!url || typeof url !== 'string') return null;
                
                // 移除无效标点符号和空白字符
                let cleanUrl = url.trim()
                    .replace(/^[^\w\-\.~:/?#[\]@!$&'()*+,;=]+/, '') // 移除开头的无效字符
                    .replace(/[^\w\-\.~:/?#[\]@!$&'()*+,;=]+$/, '') // 移除结尾的无效字符
                    .replace(/[""'']/g, '') // 移除中英文引号
                    .replace(/[，。！？；：]/g, ''); // 移除中文标点
                
                // 验证URL格式
                try {
                    new URL(cleanUrl);
                    return cleanUrl;
                } catch (e) {
                    console.warn('无效的URL:', cleanUrl);
                    return null;
                }
            }
            
            // 解析URL数组
            function parseUrlArray(urlString) {
                if (!urlString || typeof urlString !== 'string') return [];
                
                try {
                    // 尝试解析JSON数组
                    const urls = JSON.parse(urlString);
                    if (Array.isArray(urls)) {
                        return urls.map(cleanAndValidateUrl).filter(url => url !== null);
                    }
                } catch (e) {
                    // 如果不是JSON格式，尝试其他解析方式
                    console.warn('URL解析失败:', e);
                }
                
                // 尝试从字符串中提取URL
                const urlRegex = /https?:\/\/[^\s\]"']+/g;
                const matches = urlString.match(urlRegex);
                if (matches) {
                    return matches.map(cleanAndValidateUrl).filter(url => url !== null);
                }
                
                return [];
            }
            
            // 创建图片展示组件
            function createImageContainer(urls) {
                if (!urls || urls.length === 0) return null;
                
                const container = document.createElement('div');
                container.className = 'image-container';
                
                urls.forEach((url, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    
                    // 创建加载状态
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'image-loading';
                    loadingDiv.innerHTML = '<div class="loading"></div> 图片加载中...';
                    imageItem.appendChild(loadingDiv);
                    
                    // 创建图片元素
                    const img = document.createElement('img');
                    img.style.display = 'none';
                    
                    img.onload = function() {
                        loadingDiv.remove();
                        img.style.display = 'block';
                        img.style.animation = 'messageAppear 0.5s ease-out';
                    };
                    
                    img.onerror = function() {
                        loadingDiv.remove();
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'image-error';
                        errorDiv.innerHTML = '图片加载失败<br><small>点击重试</small>';
                        errorDiv.onclick = function() {
                            errorDiv.remove();
                            imageItem.appendChild(loadingDiv);
                            img.src = url; // 重新加载
                        };
                        imageItem.appendChild(errorDiv);
                    };
                    
                    img.onclick = function() {
                        showImageModal(url);
                    };
                    
                    img.src = url;
                    img.alt = `参考图片 ${index + 1}`;
                    imageItem.appendChild(img);
                    container.appendChild(imageItem);
                });
                
                return container;
            }
            
            // 显示图片预览弹窗
            function showImageModal(imageSrc) {
                const modal = document.getElementById('image-modal');
                const modalImage = document.getElementById('modal-image');
                modalImage.src = imageSrc;
                modal.classList.add('show');
            }
            
            // 添加消息到聊天框和聊天历史
            function addMessage(text, sender, imageUrls = null) {
                // 添加到聊天历史
                const messageData = {
                    sender: sender,
                    message: text
                };
                if (imageUrls && imageUrls.length > 0) {
                    messageData.images = imageUrls;
                }
                chatHistory[currentLabel].push(messageData);
                
                // 添加到聊天框
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'message user-message' : 'message ai-message';
                
                // 处理文本内容
                if (text && text.trim()) {
                    const textDiv = document.createElement('div');
                    if (sender === 'ai') {
                        textDiv.innerHTML = marked.parse(text);
                    } else {
                        textDiv.textContent = text;
                    }
                    messageDiv.appendChild(textDiv);
                }
                
                // 处理图片内容
                if (imageUrls && imageUrls.length > 0) {
                    const imageContainer = createImageContainer(imageUrls);
                    if (imageContainer) {
                        messageDiv.appendChild(imageContainer);
                    }
                }
                
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            
            // 初始化标签点击事件
            document.querySelectorAll('.label-item').forEach(item => {
                item.addEventListener('click', function() {
                    switchLabel(this.dataset.label);
                });
            });
            
            // 设置功能
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveSettingsBtn = document.getElementById('save-settings');
            const cancelSettingsBtn = document.getElementById('cancel-settings');

            // 打开设置弹窗
            settingsBtn.addEventListener('click', function() {
                // 加载当前API Key
                if (typeof config !== 'undefined' && config.apiKey) {
                    apiKeyInput.value = config.apiKey;
                }
                settingsModal.classList.add('show');
            });

            // 保存设置
            saveSettingsBtn.addEventListener('click', function() {
                const newApiKey = apiKeyInput.value.trim();
                if (newApiKey) {
                    // 更新config对象
                    if (typeof config !== 'undefined') {
                        config.apiKey = newApiKey;
                    }
                    // 这里可以添加保存到本地存储的逻辑
                    localStorage.setItem('apiKey', newApiKey);
                    alert('API Key已保存');
                } else {
                    alert('请输入有效的API Key');
                }
                settingsModal.classList.remove('show');
            });

            // 取消设置
            cancelSettingsBtn.addEventListener('click', function() {
                settingsModal.classList.remove('show');
            });

            // 点击弹窗外部关闭
            settingsModal.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    settingsModal.classList.remove('show');
                }
            });

            // 从本地存储加载API Key
            const savedApiKey = localStorage.getItem('apiKey');
            if (savedApiKey && typeof config !== 'undefined') {
                config.apiKey = savedApiKey;
            }

            // 图片预览弹窗事件处理
            const imageModal = document.getElementById('image-modal');
            const imageModalClose = document.getElementById('image-modal-close');

            // 关闭图片预览弹窗
            function closeImageModal() {
                imageModal.classList.remove('show');
            }

            // 点击关闭按钮
            imageModalClose.addEventListener('click', closeImageModal);

            // 点击弹窗背景关闭
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });

            // ESC键关闭弹窗
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && imageModal.classList.contains('show')) {
                    closeImageModal();
                }
            });

            // 事件监听
            sendBtn.addEventListener('click', sendMessage);
            userinput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>